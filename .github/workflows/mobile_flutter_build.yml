name: Flutter Mobile Build

on:
  workflow_call:

    # ------------------------------------------------------------
    # Inputs
    # ------------------------------------------------------------
    inputs:
      flutter_version:
        type: string
        default: "3.19.6"

      platform:
        type: string
        default: "android"     # android | ios | both

      build_type:
        type: string
        default: "release"     # debug | release

      android_output:
        type: string
        default: "apk"         # apk | appbundle

      working_directory:
        type: string
        default: "."

    # ------------------------------------------------------------
    # Outputs
    # ------------------------------------------------------------
    outputs:
      build_version:
        value: ${{ jobs.meta.outputs.version }}

jobs:

  # =============================================================
  # META: Versioning
  # =============================================================
  meta:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Build Version
        id: version
        run: |
          DATE=$(date +%Y%m%d)
          COUNT=$(git rev-list --count HEAD)
          VERSION="${DATE}.${COUNT}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Build version: $VERSION"

  # =============================================================
  # ANDROID BUILD
  # =============================================================
  android:
    if: inputs.platform == 'android' || inputs.platform == 'both'
    runs-on: ubuntu-latest
    needs: meta

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}

      - name: Install Dependencies
        working-directory: ${{ inputs.working_directory }}
        run: flutter pub get

      - name: Build Android
        working-directory: ${{ inputs.working_directory }}
        run: |
          if [ "${{ inputs.android_output }}" = "appbundle" ]; then
            flutter build appbundle --${{ inputs.build_type }}
          else
            flutter build apk --${{ inputs.build_type }}
          fi

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ needs.meta.outputs.version }}
          path: |
            **/build/app/outputs/**/*.apk
            **/build/app/outputs/**/*.aab

  # =============================================================
  # IOS BUILD
  # =============================================================
  ios:
    if: inputs.platform == 'ios' || inputs.platform == 'both'
    runs-on: macos-latest
    needs: meta

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}

      - name: Install Dependencies
        working-directory: ${{ inputs.working_directory }}
        run: flutter pub get

      - name: Build iOS (No Codesign)
        working-directory: ${{ inputs.working_directory }}
        run: flutter build ipa --${{ inputs.build_type }} --no-codesign

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ needs.meta.outputs.version }}
          path: |
            **/build/ios/ipa/*.ipa
