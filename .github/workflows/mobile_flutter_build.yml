name: Flutter Mobile Build

on:
  workflow_call:
    # ------------------------------------------------------------
    # Inputs
    # ------------------------------------------------------------
    inputs:
      flutter_version:
        type: string
        default: "3.19.6"

      platform:
        type: string
        default: "android" # android | ios | both

      build_type:
        type: string
        default: "release" # debug | release

      android_output:
        type: string
        default: "apk" # apk | appbundle

      working_directory:
        type: string
        default: "."

      # Optional: nơi bạn muốn đặt env.prod sau khi decode
      dotenv_target_path:
        type: string
        default: ".env"

      # Optional: iOS signing bật/tắt
      ios_codesign:
        type: boolean
        default: false

      # Optional: bundle id iOS để generate ExportOptions.plist (nếu bạn không cung cấp plist riêng)
      ios_bundle_id:
        type: string
        default: "com.eranin.etask"

      # Optional: export method (app-store | ad-hoc | development)
      ios_export_method:
        type: string
        default: "app-store"

    # ------------------------------------------------------------
    # Secrets (caller truyền vào)
    # ------------------------------------------------------------
    secrets:
      # App env
      ENV_PROD_BASE64:
        required: false

      # Firebase config
      ANDROID_GOOGLE_SERVICES_JSON_BASE64:
        required: false
      IOS_GOOGLESERVICE_INFO_PLIST_BASE64:
        required: false
      IOS_GOOGLEOAUTH_PLIST_BASE64:
        required: false

      # Android signing
      ANDROID_KEYSTORE_BASE64:
        required: false
      ANDROID_KEY_PROPERTIES_BASE64:
        required: false

      # iOS signing (P12 + mobileprovision)
      IOS_P12_BASE64:
        required: false
      IOS_P12_PASSWORD:
        required: false
      IOS_MOBILEPROVISION_BASE64:
        required: false
      IOS_KEYCHAIN_PASSWORD:
        required: false

      # Optional: cung cấp ExportOptions.plist riêng (base64)
      IOS_EXPORT_OPTIONS_PLIST_BASE64:
        required: false

    # ------------------------------------------------------------
    # Outputs
    # ------------------------------------------------------------
    outputs:
      build_version:
        value: ${{ jobs.meta.outputs.version }}

permissions:
  contents: read

jobs:
  # =============================================================
  # META: Versioning
  # =============================================================
  meta:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      count: ${{ steps.version.outputs.count }}
      date: ${{ steps.version.outputs.date }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Build Version
        id: version
        shell: bash
        run: |
          DATE=$(date +%Y%m%d)
          COUNT=$(git rev-list --count HEAD)
          VERSION="${DATE}.${COUNT}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Build version: $VERSION"

  # =============================================================
  # ANDROID BUILD
  # =============================================================
  android:
    if: inputs.platform == 'android' || inputs.platform == 'both'
    runs-on: ubuntu-latest
    needs: meta

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Android)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}
          cache: true

      - name: Inject .env (optional)
        shell: bash
        run: |
          if [ -z "$ENV_B64" ]; then
            echo "No ENV_PROD_BASE64 provided, skipping .env injection"
            exit 0
          fi
          python3 - <<'PY'
          import os, base64, pathlib
          wd = pathlib.Path(os.environ["WD"])
          target = wd / os.environ["DOTENV_TARGET"]
          target.parent.mkdir(parents=True, exist_ok=True)
          target.write_bytes(base64.b64decode(os.environ["ENV_B64"]))
          print(f"Wrote env file to: {target}")
          PY
        env:
          WD: ${{ inputs.working_directory }}
          DOTENV_TARGET: ${{ inputs.dotenv_target_path }}
          ENV_B64: ${{ secrets.ENV_PROD_BASE64 }}

      - name: Inject google-services.json (optional)
        shell: bash
        run: |
          if [ -z "$GS_B64" ]; then
            echo "No ANDROID_GOOGLE_SERVICES_JSON_BASE64 provided, skipping"
            exit 0
          fi
          python3 - <<'PY'
          import os, base64, pathlib
          wd = pathlib.Path(os.environ["WD"])
          target = wd / "android/app/google-services.json"
          target.parent.mkdir(parents=True, exist_ok=True)
          target.write_bytes(base64.b64decode(os.environ["GS_B64"]))
          print(f"Wrote: {target}")
          PY
        env:
          WD: ${{ inputs.working_directory }}
          GS_B64: ${{ secrets.ANDROID_GOOGLE_SERVICES_JSON_BASE64 }}

      - name: Inject Android signing (optional - release only)
        if: inputs.build_type == 'release'
        shell: bash
        run: |
          if [ -z "$KP_B64" ] || [ -z "$JKS_B64" ]; then
            echo "No Android signing secrets provided, skipping"
            exit 0
          fi
          python3 - <<'PY'
          import os, base64, pathlib
          wd = pathlib.Path(os.environ["WD"])

          # key.properties -> android/key.properties
          kp = wd / "android/key.properties"
          kp.parent.mkdir(parents=True, exist_ok=True)
          kp.write_bytes(base64.b64decode(os.environ["KP_B64"]))

          # key.jks -> thử ghi vào android/app/key.jks (phổ biến) + android/key.jks (dự phòng)
          jks1 = wd / "android/app/key.jks"
          jks1.parent.mkdir(parents=True, exist_ok=True)
          jks1.write_bytes(base64.b64decode(os.environ["JKS_B64"]))

          jks2 = wd / "android/key.jks"
          jks2.parent.mkdir(parents=True, exist_ok=True)
          jks2.write_bytes(base64.b64decode(os.environ["JKS_B64"]))

          print(f"Wrote: {kp}")
          print(f"Wrote: {jks1}")
          print(f"Wrote: {jks2}")
          PY
        env:
          WD: ${{ inputs.working_directory }}
          KP_B64: ${{ secrets.ANDROID_KEY_PROPERTIES_BASE64 }}
          JKS_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Install Dependencies
        working-directory: ${{ inputs.working_directory }}
        run: flutter pub get

      - name: Build Android
        working-directory: ${{ inputs.working_directory }}
        shell: bash
        run: |
          if [ "${{ inputs.android_output }}" = "appbundle" ]; then
            flutter build appbundle --${{ inputs.build_type }}
          else
            flutter build apk --${{ inputs.build_type }}
          fi

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ needs.meta.outputs.version }}
          path: |
            **/build/app/outputs/**/*.apk
            **/build/app/outputs/**/*.aab
          if-no-files-found: error

  # =============================================================
  # IOS BUILD
  # =============================================================
  ios:
    if: inputs.platform == 'ios' || inputs.platform == 'both'
    runs-on: macos-latest
    needs: meta

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}
          cache: true

      - name: Inject .env (optional)
        shell: bash
        run: |
          if [ -z "$ENV_B64" ]; then
            echo "No ENV_PROD_BASE64 provided, skipping .env injection"
            exit 0
          fi
          python3 - <<'PY'
          import os, base64, pathlib
          wd = pathlib.Path(os.environ["WD"])
          target = wd / os.environ["DOTENV_TARGET"]
          target.parent.mkdir(parents=True, exist_ok=True)
          target.write_bytes(base64.b64decode(os.environ["ENV_B64"]))
          print(f"Wrote env file to: {target}")
          PY
        env:
          WD: ${{ inputs.working_directory }}
          DOTENV_TARGET: ${{ inputs.dotenv_target_path }}
          ENV_B64: ${{ secrets.ENV_PROD_BASE64 }}

      - name: Inject GoogleService-Info.plist (optional)
        shell: bash
        run: |
          if [ -z "$PLIST_B64" ]; then
            echo "No IOS_GOOGLESERVICE_INFO_PLIST_BASE64 provided, skipping"
            exit 0
          fi
          python3 - <<'PY'
          import os, base64, pathlib
          wd = pathlib.Path(os.environ["WD"])
          target = wd / "ios/Runner/GoogleService-Info.plist"
          target.parent.mkdir(parents=True, exist_ok=True)
          target.write_bytes(base64.b64decode(os.environ["PLIST_B64"]))
          print(f"Wrote: {target}")
          PY
        env:
          WD: ${{ inputs.working_directory }}
          PLIST_B64: ${{ secrets.IOS_GOOGLESERVICE_INFO_PLIST_BASE64 }}

      - name: Inject GoogleOAuth.plist (optional)
        shell: bash
        run: |
          if [ -z "$PLIST_B64" ]; then
            echo "No IOS_GOOGLEOAUTH_PLIST_BASE64 provided, skipping"
            exit 0
          fi
          python3 - <<'PY'
          import os, base64, pathlib
          wd = pathlib.Path(os.environ["WD"])
          target = wd / "ios/Runner/GoogleOAuth.plist"
          target.parent.mkdir(parents=True, exist_ok=True)
          target.write_bytes(base64.b64decode(os.environ["PLIST_B64"]))
          print(f"Wrote: {target}")
          PY
        env:
          WD: ${{ inputs.working_directory }}
          PLIST_B64: ${{ secrets.IOS_GOOGLEOAUTH_PLIST_BASE64 }}

      - name: Install Dependencies
        working-directory: ${{ inputs.working_directory }}
        run: flutter pub get

      # -------------------------
      # iOS Codesign (optional)
      # -------------------------
      - name: Install iOS cert & provisioning (optional)
        id: ios_signing
        if: inputs.ios_codesign && inputs.build_type == 'release'
        shell: bash
        run: |
          # Check if all required secrets are provided
          if [ -z "$P12_B64" ] || [ -z "$MP_B64" ] || [ -z "$IOS_KEYCHAIN_PASSWORD" ]; then
            echo "iOS signing secrets not fully provided, skipping signing setup"
            echo "signing_configured=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          set -euo pipefail

          KEYCHAIN=build.keychain-db

          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN"
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"

          # Import p12
          python3 - <<'PY'
          import os, base64, pathlib
          p = pathlib.Path("cert.p12")
          p.write_bytes(base64.b64decode(os.environ["P12_B64"]))
          print("Wrote cert.p12")
          PY

          security import cert.p12 -k "$KEYCHAIN" -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign

          # Install provisioning profile
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          python3 - <<'PY'
          import os, base64, pathlib
          p = pathlib.Path("profile.mobileprovision")
          p.write_bytes(base64.b64decode(os.environ["MP_B64"]))
          print("Wrote profile.mobileprovision")
          PY
          cp profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/"

          echo "signing_configured=true" >> $GITHUB_OUTPUT
        env:
          P12_B64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          MP_B64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}

      - name: Prepare ExportOptions.plist (optional)
        if: inputs.ios_codesign && inputs.build_type == 'release'
        shell: bash
        run: |
          # Skip if signing was not configured
          if [ "${{ steps.ios_signing.outputs.signing_configured }}" != "true" ]; then
            echo "Signing not configured, skipping ExportOptions.plist"
            exit 0
          fi

          set -euo pipefail
          WD="${{ inputs.working_directory }}"
          TARGET="$WD/ios/ExportOptions.plist"
          mkdir -p "$WD/ios"

          if [ -n "$PLIST_B64" ]; then
            python3 - <<'PY'
          import os, base64, pathlib
          target = pathlib.Path(os.environ["TARGET"])
          target.write_bytes(base64.b64decode(os.environ["PLIST_B64"]))
          print(f"Wrote ExportOptions: {target}")
          PY
          else
            # Generate minimal ExportOptions.plist
            python3 - <<'PY'
          import os, pathlib
          method = os.environ["METHOD"]
          bundle_id = os.environ["BUNDLE_ID"]
          target = pathlib.Path(os.environ["TARGET"])

          content = f'''<?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>{method}</string>
            <key>signingStyle</key><string>manual</string>
            <key>stripSwiftSymbols</key><true/>
            <key>compileBitcode</key><false/>
            <key>destination</key><string>export</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>{bundle_id}</key><string></string>
            </dict>
          </dict>
          </plist>
          '''
          target.write_text(content)
          print(f"Generated ExportOptions: {target}")
          PY
          fi
        env:
          TARGET: ${{ inputs.working_directory }}/ios/ExportOptions.plist
          PLIST_B64: ${{ secrets.IOS_EXPORT_OPTIONS_PLIST_BASE64 }}
          METHOD: ${{ inputs.ios_export_method }}
          BUNDLE_ID: ${{ inputs.ios_bundle_id }}

      - name: Build iOS (Signed)
        if: inputs.ios_codesign && inputs.build_type == 'release' && steps.ios_signing.outputs.signing_configured == 'true'
        working-directory: ${{ inputs.working_directory }}
        run: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      - name: Build iOS (No Codesign)
        if: "!inputs.ios_codesign || inputs.build_type != 'release' || steps.ios_signing.outputs.signing_configured != 'true'"
        working-directory: ${{ inputs.working_directory }}
        run: flutter build ipa --${{ inputs.build_type }} --no-codesign

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ needs.meta.outputs.version }}
          path: |
            **/build/ios/ipa/*.ipa
          if-no-files-found: error
