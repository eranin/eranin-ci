name: Docker Build and Push

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string      # The image name without registry prefix
      dockerfile:
        type: string
        default: "Dockerfile"    # Custom Dockerfile path (optional)
      context:
        type: string
        default: "."             # Build context (default: repo root)
      platforms:
        type: string
        default: "linux/amd64"   # Build target platform(s)

    secrets:
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
      REGISTRY_URL:
        required: true           # Local registry: 103.162.20.16:5000

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # Expose image tag back to the parent workflow (CI/CD chain)
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:

      # ------------------------------------------------------------
      # 1) Checkout source code
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Needed for git logs (tag generation)

      # ------------------------------------------------------------
      # 2) Generate deterministic image tag
      # Format: YYYYMMDD_<commit_count>
      # Example: 20250128_42
      # ------------------------------------------------------------
      - name: Generate Image Tag
        id: tag
        run: |
          DATE=$(date +%Y%m%d)
          COUNT=$(git rev-list --count HEAD)
          TAG="${DATE}_${COUNT}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

      # ------------------------------------------------------------
      # 3) Configure Docker daemon to allow insecure HTTP registry
      # Required because registry at 103.x uses HTTP (no TLS)
      # ------------------------------------------------------------
      - name: Configure Docker for HTTP Registry
        run: |
          HOST="${{ secrets.REGISTRY_URL }}"
          echo "{\"insecure-registries\": [\"$HOST\"]}" | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          echo "Docker daemon configured for HTTP registry: $HOST"

      # ------------------------------------------------------------
      # 4) Setup Buildx builder with insecure registry config
      # Necessary for multi-platform builds & HTTP push
      # ------------------------------------------------------------
      - name: Setup Buildx
        run: |
          HOST="${{ secrets.REGISTRY_URL }}"
          mkdir -p /tmp/buildx

          cat <<EOF > /tmp/buildx/buildkit.toml
          [registry."$HOST"]
            http = true
            insecure = true
          EOF

          docker buildx rm builder || true
          docker buildx create \
            --name builder \
            --driver docker-container \
            --use \
            --config /tmp/buildx/buildkit.toml

          docker buildx inspect --bootstrap

      # ------------------------------------------------------------
      # 5) Docker login (HTTP)
      # Must use http:// prefix or login will attempt TLS
      # ------------------------------------------------------------
      - name: Login to Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login \
            "http://${{ secrets.REGISTRY_URL }}" \
            --username "${{ secrets.REGISTRY_USERNAME }}" \
            --password-stdin

      # ------------------------------------------------------------
      # 6) Prepare metadata (tags, full path)
      # Output:
      #   tags -> "<registry>/<image>:<tag>,<registry>/<image>:latest"
      # ------------------------------------------------------------
      - name: Prepare Metadata
        id: meta
        run: |
          HOST="${{ secrets.REGISTRY_URL }}"
          TAG="${{ steps.tag.outputs.tag }}"
          BASE="${HOST}/${{ inputs.image_name }}"

          echo "tags=${BASE}:${TAG},${BASE}:latest" >> $GITHUB_OUTPUT
          echo "full_image_name=${BASE}:${TAG}" >> $GITHUB_OUTPUT

          echo "Generated tags:"
          echo " - ${BASE}:${TAG}"
          echo " - ${BASE}:latest"

      # ------------------------------------------------------------
      # 7) Build and push Docker image using Buildx
      # ------------------------------------------------------------
      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}

      # ------------------------------------------------------------
      # 8) Summary output
      # ------------------------------------------------------------
      - name: Summary
        run: |
          echo "## Docker Build Completed" >> $GITHUB_STEP_SUMMARY
          echo "Image: ${{ secrets.REGISTRY_URL }}/${{ inputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Tag:   ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
