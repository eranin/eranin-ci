name: Docker Build and Push

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string      # Image name (without registry prefix)
      dockerfile:
        type: string
        default: "Dockerfile"    # Dockerfile path
      context:
        type: string
        default: "."             # Build context
      platforms:
        type: string
        default: "linux/amd64"   # Target platform(s)

    secrets:
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
      REGISTRY_URL:
        required: true           # Example: 103.162.20.16:5000

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # Expose the generated image tag to the parent workflow (CD)
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:

      # ------------------------------------------------------------
      # 1) Checkout repository
      # ------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0           # Required for commit counting

      # ------------------------------------------------------------
      # 2) Generate a deterministic image tag
      # Format: YYYYMMDD_<commit_count>
      # ------------------------------------------------------------
      - name: Generate Image Tag
        id: tag
        run: |
          DATE=$(date +%Y%m%d)
          COUNT=$(git rev-list --count HEAD)
          TAG="${DATE}_${COUNT}"

          # IMPORTANT: This output is used by CD
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

          echo "Generated tag: ${TAG}"

      # ------------------------------------------------------------
      # 3) Configure Docker daemon for insecure HTTP registry
      # ------------------------------------------------------------
      - name: Configure Docker for HTTP Registry
        run: |
          HOST="${{ secrets.REGISTRY_URL }}"

          echo "{\"insecure-registries\": [\"$HOST\"]}" | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

          echo "Docker configured for insecure registry: $HOST"

      # ------------------------------------------------------------
      # 4) Setup Buildx with HTTP registry support
      # ------------------------------------------------------------
      - name: Setup Buildx
        run: |
          HOST="${{ secrets.REGISTRY_URL }}"

          mkdir -p /tmp/buildx
          cat <<EOF > /tmp/buildx/buildkit.toml
          [registry."$HOST"]
            http = true
            insecure = true
          EOF

          docker buildx rm builder || true

          docker buildx create \
            --name builder \
            --driver docker-container \
            --use \
            --config /tmp/buildx/buildkit.toml

          docker buildx inspect --bootstrap

          echo "Buildx builder initialized for HTTP registry"

      # ------------------------------------------------------------
      # 5) Login to registry (must use http://)
      # ------------------------------------------------------------
      - name: Login to Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login \
            "http://${{ secrets.REGISTRY_URL }}" \
            --username "${{ secrets.REGISTRY_USERNAME }}" \
            --password-stdin

      # ------------------------------------------------------------
      # 6) Prepare image metadata
      # ------------------------------------------------------------
      - name: Prepare Metadata
        id: meta
        run: |
          HOST="${{ secrets.REGISTRY_URL }}"
          TAG="${{ steps.tag.outputs.tag }}"
          BASE="${HOST}/${{ inputs.image_name }}"

          # Output list of tags for Buildx
          echo "tags=${BASE}:${TAG},${BASE}:latest" >> $GITHUB_OUTPUT

          # Full name for reference
          echo "full_image_name=${BASE}:${TAG}" >> $GITHUB_OUTPUT

          echo "Prepared Tags:"
          echo " - ${BASE}:${TAG}"
          echo " - ${BASE}:latest"

      # ------------------------------------------------------------
      # 7) Build & Push image
      # ------------------------------------------------------------
      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}

      # ------------------------------------------------------------
      # 8) Summary (shown in GitHub UI)
      # ------------------------------------------------------------
      - name: Summary
        run: |
          echo "## Docker Build Completed" >> $GITHUB_STEP_SUMMARY
          echo "Registry: ${{ secrets.REGISTRY_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "Image:    ${{ inputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Tag:      ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
