name: Security Scan (Reusable)

on:
  workflow_call:
    inputs:
      working_directory:
        type: string
        default: "."
      enable_gitleaks:
        type: boolean
        default: true
      enable_checkov:
        type: boolean
        default: true
      enable_codeql:
        type: boolean
        default: false
      codeql_languages:
        description: "Comma-separated CodeQL languages (e.g., javascript,python,go)"
        type: string
        default: "javascript"
      fail_on_findings:
        description: Fail workflow if any enabled scan reports findings
        type: boolean
        default: true

jobs:
  secrets_scan:
    if: ${{ inputs.enable_gitleaks }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks
        id: gitleaks
        continue-on-error: true
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
      - name: Gate
        if: ${{ inputs.fail_on_findings && steps.gitleaks.outcome == 'failure' }}
        run: exit 1

  iac_scan:
    if: ${{ inputs.enable_checkov }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Checkov (IaC)
        id: checkov
        continue-on-error: true
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ inputs.working_directory }}
          output_format: sarif
          output_file_path: checkov.sarif

      - name: Upload SARIF
        if: ${{ always() && inputs.enable_checkov }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif

      - name: Gate
        if: ${{ inputs.fail_on_findings && steps.checkov.outcome == 'failure' }}
        run: exit 1

  codeql_scan:
    if: ${{ inputs.enable_codeql }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.codeql_languages }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        uses: github/codeql-action/analyze@v3
